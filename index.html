<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Pipeline Applicant FLK</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{ --brand:#3F704D; --bg:#fff; --ink:#222; }
*{ box-sizing:border-box }
html,body{ width:100%; max-width:100%; overflow-x:hidden; }
body{ margin:0; font-family:Montserrat,system-ui,Arial,sans-serif; color:var(--ink); background:var(--bg) }
/* Loading */
.loading-screen{ position:fixed; inset:0; z-index:9999; background:#0f1720; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:16px; padding:24px }
.loading-logo{ color:#E6EDF3; letter-spacing:.15em; text-transform:uppercase; font-weight:800; font-size:clamp(26px,5vw,42px); animation:blink 1.1s ease-in-out infinite }
.loading-sub{ color:#A7B2BD; font-size:14px; opacity:.9; text-align:center }
.loading-bar{ width:min(220px,60vw); height:4px; background:rgba(255,255,255,.16); border-radius:9999px; overflow:hidden; position:relative; box-shadow:0 0 0 1px rgba(255,255,255,.06) inset }
.loading-bar::before{ content:""; position:absolute; inset:0; width:40%; height:100%; background:linear-gradient(90deg,#ffffff,#cfd8e3); border-radius:inherit; animation:load 1.2s cubic-bezier(.4,0,.2,1) infinite }
@keyframes blink{0%,100%{opacity:1}50%{opacity:.25}}
@keyframes load{0%{transform:translateX(-100%)}50%{transform:translateX(30%)}100%{transform:translateX(200%)}}
@media (prefers-reduced-motion:reduce){ .loading-logo{animation:none} .loading-bar::before{animation:none; width:100%} }
.app{ opacity:0; transform:translateY(8px); transition:opacity .35s ease, transform .35s ease }
body.ready .app{ opacity:1; transform:none }
/* Layout */
.container{ padding:0 16px }
.header{ background:var(--brand); color:#fff; padding:18px 16px; position:sticky; top:0; z-index:20; box-shadow:0 2px 6px rgba(0,0,0,.08) }
.title{ margin:0; font-weight:700; font-size:clamp(18px,2.2vw,28px) }
/* Filters */
.filters{ padding:14px 0 6px; display:flex; flex-wrap:wrap; gap:12px; position:sticky; top:66px; z-index:19; background:var(--bg) }
.capsule{ width:200px; background:var(--brand); color:#fff; border-radius:9999px; min-height:44px; display:flex; align-items:center; gap:8px; padding:8px 12px; position:relative; box-shadow:0 1px 3px rgba(0,0,0,.08) }
.capsule label{ font-size:12px; font-weight:600; opacity:.95; white-space:nowrap }
.capsule select{ flex:1; background:transparent; color:#fff; border:none; outline:none; font-weight:600; font-size:13px; appearance:none; padding-right:18px }
.capsule::after{ content:""; position:absolute; right:12px; width:8px; height:8px; border-right:2px solid #fff; border-bottom:2px solid #fff; transform:rotate(45deg); top:50%; margin-top:-6px }
.capsule option{ color:#000 }
/* Sections */
.section{ margin:12px 0 24px; background:#fff; border-radius:16px; box-shadow:0 4px 10px rgba(0,0,0,.06); overflow:hidden; max-width:100% }
.section-head{ background:var(--brand); color:#fff; padding:12px 16px; font-weight:700 }
.block{ padding:12px 16px }
.block canvas{ display:block; max-width:100% }
/* Pager */
.toolbar{ display:flex; align-items:center; gap:12px; padding:0 16px 12px; color:#555; font-size:13px; flex-wrap:wrap }
.btn{ background:var(--brand); color:#fff; border:none; border-radius:10px; padding:8px 12px; font-weight:600; cursor:pointer }
.btn[disabled]{ opacity:.4; cursor:not-allowed }
.counter{ font-weight:600 }
/* Table */
.table-wrap{ padding:0 16px 16px; max-height:65vh; overflow:auto; background:#fff; max-width:100% }
table{ width:100%; border-collapse:separate; border-spacing:0 }
thead th{ position:sticky; top:0; z-index:2; background:#f7f7f7; color:#1c1c1c; border-top:3px solid var(--brand); border-bottom:2px solid #e6e6e6; text-align:left; padding:10px 8px; font-size:13px; white-space:nowrap }
tbody td{ padding:8px; border-bottom:1px solid #eee; font-size:13px; vertical-align:top }
/* Mobile */
@media (max-width:640px){
  .filters{ gap:10px; top:60px }
  .capsule{ width:100% }
  .capsule label{ display:none }
  .table-wrap{ max-height:68vh; padding:0 12px 12px }
  .block{ padding:10px 12px }
}
</style>
</head>
<body>

<!-- LOADER -->
<div id="loader" class="loading-screen" aria-live="polite" aria-busy="true">
  <div class="loading-logo">THE PIPELINE</div>
  <div class="loading-bar" role="progressbar" aria-label="Memuat"></div>
  <div id="loader-sub" class="loading-sub">Mengambil data…</div>
</div>

<header class="header"><h1 class="title">Pipeline Applicant FLK</h1></header>

<main class="container app">
  <!-- FILTERS: Tahun → Bulan → Tanggal -->
  <section class="filters">
    <div class="capsule"><label for="f-year">Tahun</label><select id="f-year"><option value="">Semua Tahun</option></select></div>
    <div class="capsule"><label for="f-month">Bulan</label><select id="f-month" disabled><option value="">Semua Bulan</option></select></div>
    <div class="capsule"><label for="f-day">Tanggal</label><select id="f-day" disabled><option value="">Semua Tanggal</option></select></div>

    <div class="capsule"><label for="f-minat">Minat Posisi</label><select id="f-minat"><option value="">Semua</option></select></div>
    <div class="capsule"><label for="f-peng">Pengalaman Terakhir</label><select id="f-peng"><option value="">Semua</option></select></div>
    <div class="capsule"><label for="f-pend">Pendidikan Terakhir</label><select id="f-pend"><option value="">Semua</option></select></div>
    <div class="capsule"><label for="f-prov">Provinsi Minat</label><select id="f-prov"><option value="">Semua</option></select></div>
    <div class="capsule"><label for="f-kota">Kota Minat</label><select id="f-kota"><option value="">Semua</option></select></div>
  </section>

  <!-- CHART -->
  <section class="section">
    <div class="section-head">Distribusi Pelamar per Kota (Top 15)</div>
    <div class="block"><canvas id="chart" height="160"></canvas></div>
    <div class="toolbar">
      <button id="prev" class="btn">Prev</button>
      <button id="next" class="btn">Next</button>
      <span>Halaman <span id="pageNum" class="counter">1</span> • Menampilkan <span id="pageCount" class="counter">0</span> dari <span id="totalCount" class="counter">0</span> baris</span>
    </div>
  </section>

  <!-- TABLE -->
  <section class="section">
    <div class="section-head">Tabel Data Pelamar</div>
    <div class="table-wrap">
      <table id="grid">
        <thead><tr id="thead-row"></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- Libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
/* ====== CONFIG ====== */
const PUB_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSYPLo0JpR72ovhAuJNEo4oUrKHpZXvgO63wCQkROikss2FnuMdWvg7KQYodED6FnOMIZaEF3EkHErj/pub?gid=670178857&single=true&output=csv";
const PROXY_CSV = "https://r.jina.ai/http://docs.google.com/spreadsheets/d/e/2PACX-1vSYPLo0JpR72ovhAuJNEo4oUrKHpZXvgO63wCQkROikss2FnuMdWvg7KQYodED6FnOMIZaEF3EkHErj/pub?gid=670178857&single=true&output=csv";
const PROXY_PUBHTML = "https://r.jina.ai/http://docs.google.com/spreadsheets/d/e/2PACX-1vSYPLo0JpR72ovhAuJNEo4oUrKHpZXvgO63wCQkROikss2FnuMdWvg7KQYodED6FnOMIZaEF3EkHErj/pubhtml?gid=670178857&single=true&widget=true&headers=true";

const PAGE_SIZE = 100;
const MONTH_NAMES = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];

const DISPLAY_COLUMNS = [
  "TIMESTAMP","EMAIL AKTIF","SUMBER INFORMASI LOWONGAN","NAMA LENGKAP (SESUAI KTP)","TANGGAL LAHIR",
  "NOMOR WA AKTIF","NOMOR HP AKTIF","JENIS KELAMIN","PENGALAMAN KERJA TERAKHIR","DURASI PENGALAMAN KERJA",
  "MINAT POSISI KERJA PERTAMA","MINAT POSISI KERJA KEDUA","MINAT POSISI KERJA KETIGA","PENDIDIKAN TERAKHIR",
  "NAMA SEKOLAH / NAMA UNIVERITAS","JURUSAN","KEPEMILIKAN KENDARAAN","KEPEMILIKAN SIM AKTIF",
  "ALAMAT DOMISILI","KECAMATAN","KELURAHAN","PROVINSI MINAT PENEMPATAN","KOTA MINAT PENEMPATAN","UPLOAD CV"
];

const FILTER_MAP = {
  ts:"TIMESTAMP", minat:"MINAT POSISI KERJA PERTAMA", peng:"PENGALAMAN KERJA TERAKHIR",
  pend:"PENDIDIKAN TERAKHIR", prov:"PROVINSI MINAT PENEMPATAN", kota:"KOTA MINAT PENEMPATAN"
};

/* ====== STATE ====== */
let HEADERS = [];
let NAME_MAP = {};    // normalized header -> real header
let ROWS = [];
let page = 0;

const $ = s => document.querySelector(s);
const norm = s => String(s||"").toUpperCase().replace(/\s+/g," ").trim();
const mapHeader = name => NAME_MAP[norm(name)] ?? name;
const get = (row, label) => row[ mapHeader(label) ];

/* UI helpers */
function hideLoader(){ const el=$("#loader"); if(!el) return; el.style.opacity="0"; el.style.transition="opacity .25s ease"; setTimeout(()=>{ el.style.display="none"; document.body.classList.add("ready"); }, 250); }
function showLoaderError(msg){ $("#loader-sub").textContent = msg || "Gagal memuat data."; }
function uniqueNumbers(arr){ return [...new Set(arr)].sort((a,b)=>a-b); }
function fillSelect(sel, values, placeholder, disable=false){
  sel.innerHTML=""; const base=document.createElement("option"); base.value=""; base.textContent=placeholder; sel.appendChild(base);
  values.forEach(v=>{ const o=document.createElement("option"); o.value=v.value; o.textContent=v.label ?? v.value; sel.appendChild(o); });
  sel.disabled = disable;
}

/* TABLE HEAD */
function buildColumns(){
  const row = $("#thead-row"); row.innerHTML="";
  DISPLAY_COLUMNS.forEach(label=>{ const th=document.createElement("th"); th.textContent=label; row.appendChild(th); });
}

/* DATE HELPERS */
function parseDateParts(s){
  if(!s) return null;
  const d = new Date(s);
  if(!isNaN(d)) return { y:d.getFullYear(), m:d.getMonth()+1, d:d.getDate() };
  const m = String(s).match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
  if(m){
    let a=+m[1], b=+m[2], y=+m[3]; if(y<100) y+=2000;
    return (a>12) ? { y, m:b, d:a } : { y, m:a, d:b };
  }
  return null;
}
function buildYearOptions(){
  const years = uniqueNumbers( ROWS.map(r=>parseDateParts(get(r,FILTER_MAP.ts))?.y).filter(Boolean) );
  fillSelect($("#f-year"), years.map(y=>({value:String(y), label:String(y)})), "Semua Tahun", years.length===0);
  fillSelect($("#f-month"), [], "Semua Bulan", true);
  fillSelect($("#f-day"), [], "Semua Tanggal", true);
}
function subsetByDate(){
  const y = parseInt($("#f-year").value || "0", 10);
  const m = parseInt($("#f-month").value || "0", 10);
  const d = parseInt($("#f-day").value || "0", 10);
  return ROWS.filter(r=>{
    const P = parseDateParts(get(r,FILTER_MAP.ts));
    if(!P) return false;
    if(y && P.y!==y) return false;
    if(m && P.m!==m) return false;
    if(d && P.d!==d) return false;
    return true;
  });
}
function buildMonthOptions(){
  const months = uniqueNumbers( subsetByDate().map(r=>parseDateParts(get(r,FILTER_MAP.ts))?.m).filter(Boolean) );
  fillSelect($("#f-month"), months.map(m=>({value:String(m), label:MONTH_NAMES[m-1]})), "Semua Bulan", months.length===0);
  fillSelect($("#f-day"), [], "Semua Tanggal", true);
}
function buildDayOptions(){
  const days = uniqueNumbers( subsetByDate().map(r=>parseDateParts(get(r,FILTER_MAP.ts))?.d).filter(Boolean) );
  fillSelect($("#f-day"), days.map(d=>({value:String(d), label:String(d)})), "Semua Tanggal", days.length===0);
}

/* FILTERED ROWS */
function filteredRows(){
  const base = subsetByDate();
  const sel = {
    minat: $("#f-minat").value, peng: $("#f-peng").value, pend: $("#f-pend").value,
    prov: $("#f-prov").value, kota: $("#f-kota").value
  };
  return base.filter(r=>{
    if(sel.minat && String(get(r,FILTER_MAP.minat)||"").trim()!==sel.minat) return false;
    if(sel.peng  && String(get(r,FILTER_MAP.peng )||"").trim()!==sel.peng ) return false;
    if(sel.pend  && String(get(r,FILTER_MAP.pend )||"").trim()!==sel.pend ) return false;
    if(sel.prov  && String(get(r,FILTER_MAP.prov )||"").trim()!==sel.prov ) return false;
    if(sel.kota  && String(get(r,FILTER_MAP.kota )||"").trim()!==sel.kota ) return false;
    return true;
  });
}
function rebuildOtherFiltersFromDate(){
  const base = subsetByDate();
  const sets = { minat:new Set(), peng:new Set(), pend:new Set(), prov:new Set(), kota:new Set() };
  base.forEach(r=>{
    sets.minat.add(String(get(r,FILTER_MAP.minat)||"").trim());
    sets.peng .add(String(get(r,FILTER_MAP.peng )||"").trim());
    sets.pend .add(String(get(r,FILTER_MAP.pend )||"").trim());
    sets.prov .add(String(get(r,FILTER_MAP.prov )||"").trim());
    sets.kota .add(String(get(r,FILTER_MAP.kota )||"").trim());
  });
  const toOps = set => [...set].filter(Boolean).sort().map(v=>({value:v,label:v}));
  const cur = { minat:$("#f-minat").value, peng:$("#f-peng").value, pend:$("#f-pend").value, prov:$("#f-prov").value, kota:$("#f-kota").value };
  fillSelect($("#f-minat"), toOps(sets.minat), "Semua");
  fillSelect($("#f-peng"),  toOps(sets.peng ), "Semua");
  fillSelect($("#f-pend"),  toOps(sets.pend ), "Semua");
  fillSelect($("#f-prov"),  toOps(sets.prov ), "Semua");
  fillSelect($("#f-kota"),  toOps(sets.kota ), "Semua");
  if(sets.minat.has(cur.minat)) $("#f-minat").value = cur.minat;
  if(sets.peng .has(cur.peng )) $("#f-peng").value  = cur.peng;
  if(sets.pend .has(cur.pend )) $("#f-pend").value  = cur.pend;
  if(sets.prov .has(cur.prov )) $("#f-prov").value  = cur.prov;
  if(sets.kota .has(cur.kota )) $("#f-kota").value  = cur.kota;
}

/* RENDER */
function buildColumns(){ const row=$("#thead-row"); row.innerHTML=""; DISPLAY_COLUMNS.forEach(l=>{ const th=document.createElement("th"); th.textContent=l; row.appendChild(th); }); }
function renderTable(rows){
  const start = page*PAGE_SIZE, slice = rows.slice(start, start+PAGE_SIZE);
  const tbody = $("#tbody"); tbody.innerHTML = "";
  slice.forEach(r=>{
    const tr=document.createElement("tr");
    DISPLAY_COLUMNS.forEach(label=>{
      const td=document.createElement("td");
      const v = get(r, label) ?? "";
      if(label.toUpperCase().includes("UPLOAD") || label.toUpperCase().includes("CV")){
        const s=String(v||""); td.innerHTML = s.startsWith("http") ? `<a href="${s}" target="_blank" rel="noopener">Link CV</a>` : s;
      } else td.textContent=v;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  $("#pageNum").textContent=(page+1);
  $("#pageCount").textContent=slice.length;
  $("#totalCount").textContent=rows.length;
  $("#prev").disabled=page<=0;
  $("#next").disabled=(start+PAGE_SIZE)>=rows.length;
}
const DataLabelPlugin={id:'valueLabel',afterDatasetsDraw(chart){const{ctx}=chart;ctx.save();ctx.fillStyle='#000';ctx.textAlign='center';ctx.textBaseline='bottom';ctx.font='10px Montserrat';(chart.getDatasetMeta(0).data||[]).forEach((bar,i)=>{const v=chart.data.datasets[0].data[i];if(v==null)return;const p=bar.tooltipPosition();ctx.fillText(String(v),p.x,p.y-2);});ctx.restore();}};
let _chart;
function renderChart(rows){
  const counts=new Map();
  rows.forEach(r=>{ const k=String(get(r,FILTER_MAP.kota)||"").trim(); if(!k) return; counts.set(k,(counts.get(k)||0)+1); });
  const top=[...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,15);
  const labels=top.map(d=>d[0]), data=top.map(d=>d[1]);
  const ctx=document.getElementById("chart"); if(_chart) _chart.destroy();
  _chart=new Chart(ctx,{ type:'bar', data:{labels,datasets:[{label:'Jumlah Pelamar',data,borderWidth:1,backgroundColor:'rgba(63,112,77,0.35)',borderColor:'#3F704D'}]}, options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{precision:0}}},plugins:{legend:{display:false}}}, plugins:[DataLabelPlugin] });
}
function recalc(){ const rows=filteredRows(); page=0; renderChart(rows); renderTable(rows); }

/* EVENTS */
document.addEventListener("change",(e)=>{
  if(e.target.matches("#f-year")){ buildMonthOptions(); rebuildOtherFiltersFromDate(); recalc(); }
  else if(e.target.matches("#f-month")){ buildDayOptions(); rebuildOtherFiltersFromDate(); recalc(); }
  else if(e.target.matches("#f-day")){ rebuildOtherFiltersFromDate(); recalc(); }
  else if(e.target.matches("#f-minat,#f-peng,#f-pend,#f-prov,#f-kota")){ recalc(); }
});
$("#prev").addEventListener("click", ()=>{ const f=filteredRows(); if(page>0){ page--; renderTable(f);} });
$("#next").addEventListener("click", ()=>{ const f=filteredRows(); if((page+1)*PAGE_SIZE < f.length){ page++; renderTable(f);} });

/* ====== LOADERS ====== */
async function papaUrl(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url,{download:true,header:true,skipEmptyLines:"greedy",worker:false,complete:res=>resolve(res),error:err=>reject(err)});
  });
}
async function fetchText(url){ const r=await fetch(url,{cache:"no-store",redirect:"follow"}); if(!r.ok) throw new Error(r.status); return r.text(); }
function normalize(res){
  const fields = res.meta?.fields?.length ? res.meta.fields : Object.keys(res.data[0]||{});
  const NAME_MAP = {}; fields.forEach(h=> NAME_MAP[norm(h)] = h);
  const rows = res.data.filter(r=>Object.keys(r).length>0);
  return { fields, NAME_MAP, rows };
}
async function parsePubhtmlToRows(html){
  const doc = new DOMParser().parseFromString(html,"text/html");
  const table = doc.querySelector("table"); if(!table) throw new Error("pubhtml: table tidak ditemukan");
  const trs = [...table.querySelectorAll("tr")];
  const headers = [...trs.shift().children].map(td=>td.textContent.trim());
  const rows = trs.map(tr=>{
    const cells=[...tr.children].map(td=>td.textContent.trim());
    const obj={}; headers.forEach((h,i)=> obj[h]=cells[i]??""); return obj;
  });
  return { headers, rows };
}

/* ====== BOOT ====== */
async function boot(){
  try{
    let result = null;
    // 1) CSV publish langsung
    try{ result = normalize(await papaUrl(`${PUB_CSV}&_=${Date.now()}`)); }
    catch(e1){
      // 2) CSV via proxy
      try{ result = normalize(await papaUrl(`${PROXY_CSV}&_=${Date.now()}`)); }
      catch(e2){
        // 3) PUBHTML via proxy -> parse tabel
        const html = await fetchText(`${PROXY_PUBHTML}&_=${Date.now()}`);
        const parsed = await parsePubhtmlToRows(html);
        // samakan struktur result seperti Papa
        result = { fields: parsed.headers, NAME_MAP:{}, rows: parsed.rows };
        result.fields.forEach(h=> result.NAME_MAP[norm(h)] = h);
      }
    }

    HEADERS = result.fields;
    NAME_MAP = result.NAME_MAP;
    ROWS    = result.rows;

    if(!ROWS.length){ showLoaderError("Tidak ada data pada sheet tersebut."); hideLoader(); return; }

    buildColumns();
    buildYearOptions();
    rebuildOtherFiltersFromDate();
    recalc();

    hideLoader();
  }catch(err){
    console.error(err);
    showLoaderError("Gagal memuat data. Jika masih muncul, kirim screenshot Console (DevTools) agar aku cek error spesifiknya.");
  }
}
boot();
</script>
</body>
</html>
