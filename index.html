<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Pipeline Applicant FLK</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{ --brand:#3F704D; --bg:#fff; --ink:#212121; --muted:#f3f4f6; --line:#e5e7eb; }
*{ box-sizing:border-box }
html,body{ width:100%; max-width:100%; overflow-x:hidden; }
body{ margin:0; font-family:Montserrat,system-ui,Arial,sans-serif; color:var(--ink); background:var(--bg) }

/* ===== Loading ===== */
.loading-screen{ position:fixed; inset:0; z-index:9999; background:#0f1720; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:16px; padding:24px }
.loading-logo{ color:#E6EDF3; letter-spacing:.15em; text-transform:uppercase; font-weight:800; font-size:clamp(26px,5vw,42px); animation:blink 1.1s ease-in-out infinite }
.loading-sub{ color:#A7B2BD; font-size:14px; opacity:.9; text-align:center }
.loading-bar{ width:min(220px,60vw); height:4px; background:rgba(255,255,255,.16); border-radius:9999px; overflow:hidden; position:relative; box-shadow:0 0 0 1px rgba(255,255,255,.06) inset }
.loading-bar::before{ content:""; position:absolute; inset:0; width:40%; height:100%; background:linear-gradient(90deg,#ffffff,#cfd8e3); border-radius:inherit; animation:load 1.2s cubic-bezier(.4,0,.2,1) infinite }
@keyframes blink{0%,100%{opacity:1}50%{opacity:.25}}
@keyframes load{0%{transform:translateX(-100%)}50%{transform:translateX(30%)}100%{transform:translateX(200%)}}
@media (prefers-reduced-motion:reduce){ .loading-logo{animation:none} .loading-bar::before{animation:none; width:100%} }
.app{ opacity:0; transform:translateY(8px); transition:opacity .35s ease, transform .35s ease }
body.ready .app{ opacity:1; transform:none }

/* ===== Header ===== */
.header{ background:var(--brand); color:#fff; padding:18px 16px; position:sticky; top:0; z-index:40; box-shadow:0 2px 6px rgba(0,0,0,.08) }
.title{ margin:0; font-weight:700; font-size:clamp(18px,2.2vw,28px) }

/* ===== Layout (Sidebar + Content) ===== */
.layout{
  display:grid;
  grid-template-columns: 300px 1fr;
  gap:16px;
  padding:16px;
  align-items:start;
}
.sidebar{
  position:sticky; top:66px; align-self:start;
  background:var(--muted);
  border-radius:14px;
  box-shadow:0 2px 10px rgba(0,0,0,.06);
  overflow:hidden;
}
.sidebar-head{
  background:var(--brand); color:#fff;
  padding:12px 14px; font-weight:700; letter-spacing:.01em;
}
.sidebar-body{ padding:12px; }

/* Mobile hamburger */
.filter-toggle{
  display:none;
  align-items:center; gap:10px;
  position:sticky; top:60px; z-index:45;
  width:fit-content; margin:0 0 8px 16px;
  padding:10px 14px; background:var(--brand); color:#fff; border:none; border-radius:14px;
  font-weight:700; letter-spacing:.02em; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.12)
}
.filter-toggle .bars{ position:relative; width:18px; height:12px }
.filter-toggle .bars::before,
.filter-toggle .bars::after,
.filter-toggle .bars > span{
  content:""; position:absolute; left:0; right:0; height:2px; background:#fff; border-radius:2px
}
.filter-toggle .bars::before{ top:0 }
.filter-toggle .bars > span{ top:5px }
.filter-toggle .bars::after{ bottom:0 }

/* ===== Filters (kapsul) ===== */
.filters{ display:grid; grid-template-columns: 1fr; gap:10px; }
.capsule{
  width:100%; background:#f1f3f5; color:var(--ink);
  border:1px solid var(--line);
  border-radius:12px; min-height:48px; position:relative;
  box-shadow:0 1px 2px rgba(0,0,0,.04);
  padding:6px 34px 6px 12px;
}
.capsule label{
  position:absolute; left:12px; right:34px; top:6px; margin:0;
  font-size:11px; font-weight:800; letter-spacing:.02em;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis; pointer-events:none
}
.capsule .cap-value{
  position:absolute; left:12px; right:34px; bottom:6px;
  color:var(--brand); font-weight:400; font-size:12px;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis; pointer-events:none
}
.capsule .cap-value:empty{ display:none }
.capsule select{
  position:absolute; inset:0; width:100%; height:100%;
  background:transparent; border:none; outline:none; opacity:0; cursor:pointer; appearance:none; z-index:1;
}
.cap-reset{
  position:absolute; right:6px; top:50%; transform:translateY(-50%);
  z-index:2; width:22px; height:22px; border-radius:9999px;
  background:rgba(0,0,0,.06); color:#111;
  border:none; cursor:pointer; display:none; line-height:22px; font-size:14px;
}
.cap-reset.show{ display:inline-grid; place-items:center }
.cap-reset:hover{ background:rgba(0,0,0,.12) }

/* ===== Stats cards ===== */
.section{ margin-bottom:16px; background:#fff; border-radius:16px; box-shadow:0 4px 10px rgba(0,0,0,.06); overflow:hidden; }
.section-head{ background:var(--brand); color:#fff; padding:12px 16px; font-weight:700 }
.block{ padding:12px 16px }

.stats{ display:grid; grid-template-columns: repeat(3, minmax(180px, 1fr)); gap:12px }
.stat-card{
  background:#fff; border:1px solid var(--line); border-radius:12px;
  padding:12px; box-shadow:0 2px 6px rgba(0,0,0,.04)
}
.stat-label{ font-size:12px; font-weight:700; color:#334155; margin:0 0 6px }
.stat-kpi{ font-size:28px; font-weight:800; color:var(--brand); line-height:1 }
.stat-sub{ font-size:11px; color:#64748b; margin-top:4px }

/* Pager */
.toolbar{ display:flex; align-items:center; gap:12px; padding:0 16px 12px; color:#555; font-size:13px; flex-wrap:wrap }
.btn{ background:var(--brand); color:#fff; border:none; border-radius:10px; padding:8px 12px; font-weight:600; cursor:pointer }
.btn[disabled]{ opacity:.4; cursor:not-allowed }
.counter{ font-weight:600 }

/* ===== Table (scrollable both axes) ===== */
.table-wrap{
  padding:0 16px 16px;
  max-height:65vh;
  overflow:auto;          /* penting untuk scroll */
  -webkit-overflow-scrolling: touch;
  background:#fff;
}
table{
  width:100%;
  min-width: 1600px;      /* paksa lebar, agar bisa horizontal scroll */
  border-collapse:separate; border-spacing:0
}
thead th{
  position:sticky; top:0; z-index:2;
  background:#f7f7f7; color:#1c1c1c;
  border-top:3px solid var(--brand); border-bottom:2px solid #e6e6e6;
  text-align:left; padding:10px 8px; font-size:13px; white-space:nowrap
}
tbody td{ padding:8px; border-bottom:1px solid #eee; font-size:13px; vertical-align:top; white-space:nowrap }

/* ===== Mobile ===== */
@media (max-width: 900px){ .layout{ grid-template-columns: 260px 1fr; } }
@media (max-width: 640px){
  .layout{ grid-template-columns: 1fr; padding:0 0 16px }
  .filter-toggle{ display:flex }
  .sidebar{ display:none }
  .sidebar.open{
    display:block; position:fixed; left:0; right:0; top:60px; bottom:0;
    border-radius:0; z-index:50; overflow:auto;
  }
  .sidebar-body{ padding:12px }
  .stats{ grid-template-columns:1fr }
}
</style>
</head>
<body>

<!-- LOADER -->
<div id="loader" class="loading-screen" aria-live="polite" aria-busy="true">
  <div class="loading-logo">THE PIPELINE</div>
  <div class="loading-bar" role="progressbar" aria-label="Memuat"></div>
  <div id="loader-sub" class="loading-sub">Mengambil data…</div>
</div>

<header class="header"><h1 class="title">Pipeline Applicant FLK</h1></header>

<!-- Mobile toggle -->
<button id="filterToggle" class="filter-toggle" aria-controls="filterSidebar" aria-expanded="false" type="button">
  <span class="bars"><span></span></span>
  <span class="label">Filter</span>
</button>

<main class="app">
  <div class="layout">
    <!-- SIDEBAR FILTER -->
    <aside id="filterSidebar" class="sidebar" aria-label="Filter">
      <div class="sidebar-head">Filter</div>
      <div class="sidebar-body">
        <section id="filters" class="filters">
          <!-- Tahun -->
          <div class="capsule">
            <button class="cap-reset" data-for="f-year" aria-label="Hapus filter Tahun" title="Reset">✕</button>
            <label for="f-year">Tahun</label><span class="cap-value" id="val-year"></span>
            <select id="f-year"><option value="">Semua Tahun</option></select>
          </div>
          <!-- Bulan -->
          <div class="capsule">
            <button class="cap-reset" data-for="f-month" aria-label="Hapus filter Bulan" title="Reset">✕</button>
            <label for="f-month">Bulan</label><span class="cap-value" id="val-month"></span>
            <select id="f-month" disabled><option value="">Semua Bulan</option></select>
          </div>
          <!-- Tanggal -->
          <div class="capsule">
            <button class="cap-reset" data-for="f-day" aria-label="Hapus filter Tanggal" title="Reset">✕</button>
            <label for="f-day">Tanggal</label><span class="cap-value" id="val-day"></span>
            <select id="f-day" disabled><option value="">Semua Tanggal</option></select>
          </div>
          <!-- Minat -->
          <div class="capsule">
            <button class="cap-reset" data-for="f-minat" aria-label="Hapus filter Minat Posisi" title="Reset">✕</button>
            <label for="f-minat">Minat Posisi</label><span class="cap-value" id="val-minat"></span>
            <select id="f-minat"><option value="">Semua</option></select>
          </div>
          <!-- Pengalaman -->
          <div class="capsule">
            <button class="cap-reset" data-for="f-peng" aria-label="Hapus filter Pengalaman" title="Reset">✕</button>
            <label for="f-peng">Pengalaman Terakhir</label><span class="cap-value" id="val-peng"></span>
            <select id="f-peng"><option value="">Semua</option></select>
          </div>
          <!-- Pendidikan -->
          <div class="capsule">
            <button class="cap-reset" data-for="f-pend" aria-label="Hapus filter Pendidikan" title="Reset">✕</button>
            <label for="f-pend">Pendidikan Terakhir</label><span class="cap-value" id="val-pend"></span>
            <select id="f-pend"><option value="">Semua</option></select>
          </div>
          <!-- Provinsi -->
          <div class="capsule">
            <button class="cap-reset" data-for="f-prov" aria-label="Hapus filter Provinsi" title="Reset">✕</button>
            <label for="f-prov">Provinsi Minat</label><span class="cap-value" id="val-prov"></span>
            <select id="f-prov"><option value="">Semua</option></select>
          </div>
          <!-- Kota -->
          <div class="capsule">
            <button class="cap-reset" data-for="f-kota" aria-label="Hapus filter Kota" title="Reset">✕</button>
            <label for="f-kota">Kota Minat</label><span class="cap-value" id="val-kota"></span>
            <select id="f-kota"><option value="">Semua</option></select>
          </div>
        </section>
      </div>
    </aside>

    <!-- KONTEN DATA -->
    <div class="content">
      <!-- STATS (ganti pie) -->
      <section class="section">
        <div class="section-head">Ringkasan Pelamar</div>
        <div class="block">
          <div class="stats">
            <div class="stat-card">
              <div class="stat-label">Total Pelamar</div>
              <div id="stat-total" class="stat-kpi">0</div>
              <div class="stat-sub">baris hasil filter</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Fresh Graduate</div>
              <div id="stat-fresh" class="stat-kpi">0</div>
              <div class="stat-sub">durasi 0 / fresh</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Experienced</div>
              <div id="stat-exp" class="stat-kpi">0</div>
              <div class="stat-sub">durasi &gt; 0</div>
            </div>
          </div>
        </div>
        <div class="toolbar">
          <button id="prev" class="btn">Prev</button>
          <button id="next" class="btn">Next</button>
          <span>Halaman <span id="pageNum" class="counter">1</span> • Menampilkan <span id="pageCount" class="counter">0</span> dari <span id="totalCount" class="counter">0</span> baris</span>
        </div>
      </section>

      <!-- TABLE -->
      <section class="section">
        <div class="section-head">Tabel Data Pelamar</div>
        <div class="table-wrap">
          <table id="grid">
            <thead><tr id="thead-row"></tr></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>
</main>

<!-- Libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
/* ====== CONFIG ====== */
const PUB_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSYPLo0JpR72ovhAuJNEo4oUrKHpZXvgO63wCQkROikss2FnuMdWvg7KQYodED6FnOMIZaEF3EkHErj/pub?gid=670178857&single=true&output=csv";
const PROXY_CSV = "https://r.jina.ai/http://docs.google.com/spreadsheets/d/e/2PACX-1vSYPLo0JpR72ovhAuJNEo4oUrKHpZXvgO63wCQkROikss2FnuMdWvg7KQYodED6FnOMIZaEF3EkHErj/pub?gid=670178857&single=true&output=csv";
const PROXY_PUBHTML = "https://r.jina.ai/http://docs.google.com/spreadsheets/d/e/2PACX-1vSYPLo0JpR72ovhAuJNEo4oUrKHpZXvgO63wCQkROikss2FnuMdWvg7KQYodED6FnOMIZaEF3EkHErj/pubhtml?gid=670178857&single=true&widget=true&headers=true";

const PAGE_SIZE = 100;

const DISPLAY_COLUMNS = [
  "TIMESTAMP","EMAIL AKTIF","SUMBER INFORMASI LOWONGAN","NAMA LENGKAP (SESUAI KTP)","TANGGAL LAHIR",
  "NOMOR WA AKTIF","NOMOR HP AKTIF","JENIS KELAMIN","PENGALAMAN KERJA TERAKHIR","DURASI PENGALAMAN KERJA",
  "MINAT POSISI KERJA PERTAMA","MINAT POSISI KERJA KEDUA","MINAT POSISI KERJA KETIGA","PENDIDIKAN TERAKHIR",
  "NAMA SEKOLAH / NAMA UNIVERITAS","JURUSAN","KEPEMILIKAN KENDARAAN","KEPEMILIKAN SIM AKTIF",
  "ALAMAT DOMISILI","KECAMATAN","KELURAHAN","PROVINSI MINAT PENEMPATAN","KOTA MINAT PENEMPATAN","UPLOAD CV"
];

const FILTER_MAP = {
  ts:"TIMESTAMP",
  minat:"MINAT POSISI KERJA PERTAMA",
  peng:"PENGALAMAN KERJA TERAKHIR",
  pend:"PENDIDIKAN TERAKHIR",
  prov:"PROVINSI MINAT PENEMPATAN",
  kota:"KOTA MINAT PENEMPATAN",
  durasi:"DURASI PENGALAMAN KERJA"
};

/* ====== STATE ====== */
let HEADERS = [];
let NAME_MAP = {};
let ROWS = [];
let page = 0;

const $ = s => document.querySelector(s);
const norm = s => String(s||"").toUpperCase().replace(/\s+/g," ").trim();
const mapHeader = name => NAME_MAP[norm(name)] ?? name;
const get = (row, label) => row[ mapHeader(label) ];

/* Helpers */
function hideLoader(){ const el=$("#loader"); if(!el) return; el.style.opacity="0"; el.style.transition="opacity .25s ease"; setTimeout(()=>{ el.style.display="none"; document.body.classList.add("ready"); }, 250); }
function showLoaderError(msg){ $("#loader-sub").textContent = msg || "Gagal memuat data."; }
function uniqueNumbers(arr){ return [...new Set(arr)].sort((a,b)=>a-b); }
function fillSelect(sel, values, placeholder, disable=false){
  sel.innerHTML=""; const base=document.createElement("option"); base.value=""; base.textContent=placeholder; sel.appendChild(base);
  values.forEach(v=>{ const o=document.createElement("option"); o.value=v.value; o.textContent=v.label ?? v.value; sel.appendChild(o); });
  sel.disabled = disable;
}

/* TABLE HEAD */
function buildColumns(){
  const row = $("#thead-row"); row.innerHTML="";
  DISPLAY_COLUMNS.forEach(label=>{ const th=document.createElement("th"); th.textContent=label; row.appendChild(th); });
}

/* DATE options & filtering */
function parseDateParts(s){
  if(!s) return null;
  const d = new Date(s);
  if(!isNaN(d)) return { y:d.getFullYear(), m:d.getMonth()+1, d:d.getDate() };
  const m = String(s).match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
  if(m){
    let a=+m[1], b=+m[2], y=+m[3]; if(y<100) y+=2000;
    return (a>12) ? { y, m:b, d:a } : { y, m:a, d:b };
  }
  return null;
}
function buildYearOptions(){
  const years = uniqueNumbers( ROWS.map(r=>parseDateParts(get(r,FILTER_MAP.ts))?.y).filter(Boolean) );
  fillSelect($("#f-year"), years.map(y=>({value:String(y), label:String(y)})), "Semua Tahun", years.length===0);
  fillSelect($("#f-month"), [], "Semua Bulan", true);
  fillSelect($("#f-day"), [], "Semua Tanggal", true);
}
function subsetByDate(){
  const y = parseInt($("#f-year").value || "0", 10);
  const m = parseInt($("#f-month").value || "0", 10);
  const d = parseInt($("#f-day").value || "0", 10);
  return ROWS.filter(r=>{
    const P = parseDateParts(get(r,FILTER_MAP.ts));
    if(!P) return false;
    if(y && P.y!==y) return false;
    if(m && P.m!==m) return false;
    if(d && P.d!==d) return false;
    return true;
  });
}
function buildMonthOptions(){
  const months = uniqueNumbers( subsetByDate().map(r=>parseDateParts(get(r,FILTER_MAP.ts))?.m).filter(Boolean) );
  const MONTH_NAMES = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
  fillSelect($("#f-month"), months.map(m=>({value:String(m), label:MONTH_NAMES[m-1]})), "Semua Bulan", months.length===0);
  fillSelect($("#f-day"), [], "Semua Tanggal", true);
}
function buildDayOptions(){
  const days = uniqueNumbers( subsetByDate().map(r=>parseDateParts(get(r,FILTER_MAP.ts))?.d).filter(Boolean) );
  fillSelect($("#f-day"), days.map(d=>({value:String(d), label:String(d)})), "Semua Tanggal", days.length===0);
}

/* FILTERED ROWS */
function filteredRows(){
  const base = subsetByDate();
  const sel = { minat:$("#f-minat").value, peng:$("#f-peng").value, pend:$("#f-pend").value, prov:$("#f-prov").value, kota:$("#f-kota").value };
  return base.filter(r=>{
    if(sel.minat && String(get(r,FILTER_MAP.minat)||"").trim()!==sel.minat) return false;
    if(sel.peng  && String(get(r,FILTER_MAP.peng )||"").trim()!==sel.peng ) return false;
    if(sel.pend  && String(get(r,FILTER_MAP.pend )||"").trim()!==sel.pend ) return false;
    if(sel.prov  && String(get(r,FILTER_MAP.prov )||"").trim()!==sel.prov ) return false;
    if(sel.kota  && String(get(r,FILTER_MAP.kota )||"").trim()!==sel.kota ) return false;
    return true;
  });
}
function rebuildOtherFiltersFromDate(){
  const base = subsetByDate();
  const sets = { minat:new Set(), peng:new Set(), pend:new Set(), prov:new Set(), kota:new Set() };
  base.forEach(r=>{
    sets.minat.add(String(get(r,FILTER_MAP.minat)||"").trim());
    sets.peng .add(String(get(r,FILTER_MAP.peng )||"").trim());
    sets.pend .add(String(get(r,FILTER_MAP.pend )||"").trim());
    sets.prov .add(String(get(r,FILTER_MAP.prov )||"").trim());
    sets.kota .add(String(get(r,FILTER_MAP.kota )||"").trim());
  });
  const toOps = set => [...set].filter(Boolean).sort().map(v=>({value:v,label:v}));
  const cur = { minat:$("#f-minat").value, peng:$("#f-peng").value, pend:$("#f-pend").value, prov:$("#f-prov").value, kota:$("#f-kota").value };
  fillSelect($("#f-minat"), toOps(sets.minat), "Semua");
  fillSelect($("#f-peng"),  toOps(sets.peng ), "Semua");
  fillSelect($("#f-pend"),  toOps(sets.pend ), "Semua");
  fillSelect($("#f-prov"),  toOps(sets.prov ), "Semua");
  fillSelect($("#f-kota"),  toOps(sets.kota ), "Semua");
  if(sets.minat.has(cur.minat)) $("#f-minat").value = cur.minat;
  if(sets.peng .has(cur.peng )) $("#f-peng").value  = cur.peng;
  if(sets.pend .has(cur.pend )) $("#f-pend").value  = cur.pend;
  if(sets.prov .has(cur.prov )) $("#f-prov").value  = cur.prov;
  if(sets.kota .has(cur.kota )) $("#f-kota").value  = cur.kota;
}

/* ====== CAPSULE VALUE UI ====== */
function updateCapsuleValues(){
  const map = [
    ['#f-year',  '#val-year'],
    ['#f-month', '#val-month'],
    ['#f-day',   '#val-day'],
    ['#f-minat', '#val-minat'],
    ['#f-peng',  '#val-peng'],
    ['#f-pend',  '#val-pend'],
    ['#f-prov',  '#val-prov'],
    ['#f-kota',  '#val-kota'],
  ];
  map.forEach(([selId,valId])=>{
    const sel  = document.querySelector(selId);
    const span = document.querySelector(valId);
    if(!sel || !span) return;
    const hasValue = sel.selectedIndex > 0;
    span.textContent = hasValue ? sel.options[sel.selectedIndex].text : '';
    const cap = sel.closest('.capsule');
    const btn = cap && cap.querySelector('.cap-reset');
    if(btn) btn.classList.toggle('show', hasValue);
  });
}

/* ====== CLASSIFY FRESH / EXP ====== */
function isFreshGraduate(row){
  const durRaw = String(get(row, FILTER_MAP.durasi)||"").toLowerCase();
  const peng   = String(get(row, FILTER_MAP.peng)||"").toLowerCase();
  const t = (durRaw + " " + peng);

  // kata kunci kuat
  if(/fresh\s*graduate|freshgrad|fresh\b/.test(t)) return true;
  if(/belum.*pengalaman|tanpa.*pengalaman|no.*experience/.test(t)) return true;

  // numeric durasi (bulan/tahun)
  const numMatch = durRaw.match(/(\d+(?:[.,]\d+)?)/);
  if(numMatch){
    const val = parseFloat(numMatch[1].replace(',','.'));
    if(val === 0) return true;
    if(val > 0) return false;
  }

  // default: kosongkan = fresh jika kolom pengalaman juga kosong/negatif
  if(!durRaw.trim() && (!peng.trim() || /-+|tidak|belum/.test(peng))) return true;

  return false; // asumsikan experienced bila tidak jelas
}

/* ====== TABLE RENDER ====== */
function renderTable(rows){
  const start = page*PAGE_SIZE, slice = rows.slice(start, start+PAGE_SIZE);
  const tbody = $("#tbody"); tbody.innerHTML = "";
  slice.forEach(r=>{
    const tr=document.createElement("tr");
    DISPLAY_COLUMNS.forEach(label=>{
      const td=document.createElement("td");
      const v = get(r, label) ?? "";
      if(label.toUpperCase().includes("UPLOAD") || label.toUpperCase().includes("CV")){
        const s=String(v||""); td.innerHTML = s.startsWith("http") ? `<a href="${s}" target="_blank" rel="noopener">Link CV</a>` : s;
      } else td.textContent=v;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  $("#pageNum").textContent=(page+1);
  $("#pageCount").textContent=slice.length;
  $("#totalCount").textContent=rows.length;
  $("#prev").disabled=page<=0;
  $("#next").disabled=(start+PAGE_SIZE)>=rows.length;
}

/* ====== STATS ====== */
function renderStats(rows){
  const total = rows.length;
  let fresh = 0;
  rows.forEach(r=>{ if(isFreshGraduate(r)) fresh++; });
  const exp = total - fresh;

  $("#stat-total").textContent = total.toLocaleString('id-ID');
  $("#stat-fresh").textContent = fresh.toLocaleString('id-ID');
  $("#stat-exp").textContent   = exp.toLocaleString('id-ID');
}

/* ====== RECALC ====== */
function recalc(){ const rows=filteredRows(); page=0; renderStats(rows); renderTable(rows); updateCapsuleValues(); }

/* ====== EVENTS ====== */
document.addEventListener("change",(e)=>{
  if(e.target.matches("#f-year")){ buildMonthOptions(); rebuildOtherFiltersFromDate(); recalc(); }
  else if(e.target.matches("#f-month")){ buildDayOptions(); rebuildOtherFiltersFromDate(); recalc(); }
  else if(e.target.matches("#f-day")){ rebuildOtherFiltersFromDate(); recalc(); }
  else if(e.target.matches("#f-minat,#f-peng,#f-pend,#f-prov,#f-kota")){ recalc(); }
});

$("#prev").addEventListener("click", ()=>{ const f=filteredRows(); if(page>0){ page--; renderTable(f);} });
$("#next").addEventListener("click", ()=>{ const f=filteredRows(); if((page+1)*PAGE_SIZE < f.length){ page++; renderTable(f);} });

/* Reset cepat per filter (ikon ✕) */
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.cap-reset');
  if(!btn) return;
  const targetId = btn.getAttribute('data-for');
  const sel = document.getElementById(targetId);
  if(!sel) return;
  sel.value = '';
  sel.dispatchEvent(new Event('change', { bubbles:true }));
});

/* ====== MOBILE: toggle sidebar ====== */
const sidebarEl = document.getElementById('filterSidebar');
const toggleBtn  = document.getElementById('filterToggle');
if (toggleBtn && sidebarEl) {
  toggleBtn.addEventListener('click', () => {
    const open = sidebarEl.classList.toggle('open');
    toggleBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
  });
}
const isMobileView = () => window.matchMedia('(max-width: 640px)').matches;
document.addEventListener('change', (e) => {
  if (isMobileView() && e.target.closest('#filters')) {
    setTimeout(() => {
      sidebarEl.classList.remove('open');
      if (toggleBtn) toggleBtn.setAttribute('aria-expanded', 'false');
    }, 80);
  }
});

/* ====== LOADING DATA (CSV → proxy → pubhtml) ====== */
async function papaUrl(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url,{download:true,header:true,skipEmptyLines:"greedy",worker:false,complete:res=>resolve(res),error:err=>reject(err)});
  });
}
async function fetchText(url){ const r=await fetch(url,{cache:"no-store",redirect:"follow"}); if(!r.ok) throw new Error(r.status); return r.text(); }
function normalize(res){
  const fields = res.meta?.fields?.length ? res.meta.fields : Object.keys(res.data[0]||{});
  const NAME_MAP = {}; fields.forEach(h=> NAME_MAP[norm(h)] = h);
  const rows = res.data.filter(r=>Object.keys(r).length>0);
  return { fields, NAME_MAP, rows };
}
async function parsePubhtmlToRows(html){
  const doc = new DOMParser().parseFromString(html,"text/html");
  const table = doc.querySelector("table"); if(!table) throw new Error("pubhtml: table tidak ditemukan");
  const trs = [...table.querySelectorAll("tr")];
  const headers = [...trs.shift().children].map(td=>td.textContent.trim());
  const rows = trs.map(tr=>{
    const cells=[...tr.children].map(td=>td.textContent.trim());
    const obj={}; headers.forEach((h,i)=> obj[h]=cells[i]??""); return obj;
  });
  return { headers, rows };
}

/* ====== BOOT ====== */
async function boot(){
  try{
    let result = null;
    try{ result = normalize(await papaUrl(`${PUB_CSV}&_=${Date.now()}`)); }
    catch(e1){
      try{ result = normalize(await papaUrl(`${PROXY_CSV}&_=${Date.now()}`)); }
      catch(e2){
        const html = await fetchText(`${PROXY_PUBHTML}&_=${Date.now()}`);
        const parsed = await parsePubhtmlToRows(html);
        result = { fields: parsed.headers, NAME_MAP:{}, rows: parsed.rows };
        result.fields.forEach(h=> result.NAME_MAP[norm(h)] = h);
      }
    }
    HEADERS = result.fields; NAME_MAP = result.NAME_MAP; ROWS = result.rows;
    if(!ROWS.length){ showLoaderError("Tidak ada data pada sheet tersebut."); hideLoader(); return; }

    buildColumns();
    buildYearOptions();
    rebuildOtherFiltersFromDate();
    recalc();
    updateCapsuleValues();

    hideLoader();
  }catch(err){
    console.error(err);
    showLoaderError("Gagal memuat data. Cek Console untuk detail error.");
  }
}
boot();
</script>
</body>
</html>
